<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Splinterlands Cards Easy Automatic Monitoring</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #FFFFFF;
            padding-bottom: 150px;
        }
        h1 {
            text-align: center;
        }
        form {
            max-width: 640px;
            margin: 0 auto;
        }

        /* 5-line Username Textarea */
        textarea#usernames {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            background-color: #333333;
            color: #FFFFFF;
            border: 1px solid #555555;
            resize: vertical;
            font-family: Arial, sans-serif;
        }

        /* Dropdowns: Show complete words */
        select {
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            background-color: #333333;
            color: #FFFFFF;
            border: 1px solid #555555;
            width: auto;
            min-width: 140px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }

        #results {
            margin-top: 20px;
            max-width: 95%;
            margin: 20px auto;
        }
        .user-results {
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #1e1e1e;
        }
        th, td {
            border: 1px solid #555555;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #333333;
            position: sticky;
            top: 0;
            z-index: 1;
            font-size: 13px;
            line-height: 1.2;
        }
        img.card-image {
            width: 60px;
            height: auto;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #333333;
            color: #ffffff;
            padding: 10px;
            text-align: center;
        }
        .footer-content p {
            margin: 5px 0;
            font-size: 12px;
            line-height: 1.2;
        }
    </style>
</head>
<body onload="updateEditionDropdown()">

    <h1>Splinterlands Cards Monitoring 2026</h1>
    
    <form id="collectionForm">
        <textarea id="usernames" name="usernames" rows="5" placeholder="Enter usernames (one per line or comma-separated)"></textarea>

        <div>
            <input type="checkbox" id="allCheckbox" checked>
            <label for="allCheckbox">Aggregate All Accounts</label>
        </div><br>

        <label for="cardSetFilter">Card Set:</label>
        <select id="cardSetFilter" onchange="updateEditionDropdown()">
            <option value="">All</option>
            <option value="alpha">Alpha</option>
            <option value="beta">Beta</option>
            <option value="untamed">Untamed</option>
            <option value="chaos">Chaos</option>
            <option value="rebellion">Rebellion</option>
            <option value="conclave">Conclave Arcana</option>
            <option value="gladius">Gladius</option>
            <option value="foundations">Foundations</option>
        </select>

        <label for="editionFilter">Edition:</label>
        <select id="editionFilter">
            <option value="">All</option>
        </select>

        <label for="colorFilter">Splinter:</label>
        <select id="colorFilter">
            <option value="">All</option>
            <option value="life">Life</option>
            <option value="earth">Earth</option>
            <option value="water">Water</option>
            <option value="death">Death</option>
            <option value="dragon">Dragon</option>
            <option value="neutral">Neutral</option>
            <option value="fire">Fire</option>
        </select>

        <label for="typeFilter">Type:</label>
        <select id="typeFilter">
            <option value="">All</option>
            <option value="monster">Monster</option>
            <option value="summoner">Summoner</option>
        </select>

        <label for="rarityFilter">Rarity:</label>
        <select id="rarityFilter">
            <option value="">All</option>
            <option value="common">Common</option>
            <option value="rare">Rare</option>
            <option value="epic">Epic</option>
            <option value="legendary">Legendary</option>
        </select>

        <button type="button" onclick="computeCollection()">Compute Collection</button>
    </form>

    <div id="results"></div>

    <footer>
        <div class="footer-content">   
            <p>Developed by: Mitchelle V. dela Cruz | Contact: mitchellevdelacruz@gmail.com</p>
            <p>IGN: ferexian | &copy; 2024 Splinterlands Cards Easy Automatic Monitoring</p>
        </div>
    </footer>

    <script>
// Specific Edition Mapping for Images and Folders
const EDITION_PATHS = {
    '0': { folder: 'cards_v2.2', ext: 'png' }, // Alpha Core
    '1': { folder: 'cards_v2.2', ext: 'png' }, // Alpha Promo / Beta Core
    '2': { folder: 'cards_v2.2', ext: 'jpg' }, // Promo (Shared Chaos, Untamed, Reb, Conclave)
    '3': { folder: 'cards_beta', ext: 'png' }, // Beta Reward / Chaos Reward 1 / Untamed Reward
    '4': { folder: 'cards_untamed', ext: 'png' }, // Untamed Core
    '5': { folder: 'cards_untamed', ext: 'png' }, // Azmare Dice
    '6': { folder: 'cards_gladiator', ext: 'png' }, // Gladiator
    '7': { folder: 'cards_chaos', ext: 'jpg' }, // Chaos Core
    '8': { folder: 'cards_riftwatchers', ext: 'jpg' }, 
    '10': { folder: 'cards_soulbound', ext: 'jpg' }, // Chaos Reward 2
    '12': { folder: 'cards_rebellion', ext: 'jpg' }, // Rebellion Core
    '13': { folder: 'cards_soulboundrb', ext: 'jpg' }, // Rebellion Reward
    '14': { folder: 'cards_v2.2', ext: 'jpg' }, // Conclave Core
    '15': { folder: 'cards_v2.2', ext: 'jpg' }, // Foundations
	'16': { folder: 'cards_v2.2', ext: 'jpg' }, // Foundations Extra
    '17': { folder: 'cards_v2.2', ext: 'jpg' }, // Conclave Extra
    '18': { folder: 'cards_v2.2', ext: 'jpg' }, // Conclave Reward
    '19': { folder: 'cards_land', ext: 'jpg' }  // Land
};

const SET_TO_EDITION = {
    'alpha': [['0', 'Core'], ['1', 'Promo']],
    'beta': [['1', 'Core'], ['2', 'Promo'], ['3', 'Reward']],
    'untamed': [['4', 'Core'], ['2', 'Promo'], ['3', 'Rewards'], ['5', 'Azmare Dice']],
    'chaos': [['7', 'Core'], ['2', 'Promo'], ['3', 'Reward 1'], ['8', 'Riftwatcher'], ['10', 'Reward 2']],
    'rebellion': [['12', 'Core'], ['13', 'Reward'], ['2', 'Promo']],
    'conclave': [['14', 'Core'], ['17', 'Extra'], ['2', 'Promo'], ['18', 'Reward']],
    'gladius': [['6', 'Gladiator'], ['19', 'Land']],
    'foundations': [['15', 'Foundations'], ['16', 'Extra']]
};

function updateEditionDropdown() {
    const setFilter = document.getElementById('cardSetFilter').value;
    const editionSelect = document.getElementById('editionFilter');
    editionSelect.innerHTML = '<option value="">All</option>';

    if (setFilter === "") {
        editionSelect.disabled = true;
        editionSelect.value = "";
    } else {
        editionSelect.disabled = false;
        if (SET_TO_EDITION[setFilter]) {
            SET_TO_EDITION[setFilter].forEach(ed => addOption(editionSelect, ed));
        }
    }
}

function addOption(select, edArray) {
    const opt = document.createElement('option');
    opt.value = edArray[0];
    opt.textContent = `${edArray[0]} (${edArray[1]})`;
    select.appendChild(opt);
}

let cardDetails = {};
async function fetchCardDetails() {
    try {
        const response = await fetch('https://api.splinterlands.io/cards/get_details');
        const data = await response.json();
        data.forEach(card => cardDetails[card.id] = card);
    } catch (e) { console.error('Error loading card metadata'); }
}

function getRarityText(rarity) {
    return { 1: 'common', 2: 'rare', 3: 'epic', 4: 'legendary' }[rarity] || 'unknown';
}

function getColorText(color) {
    const colors = { 'white': 'life', 'green': 'earth', 'blue': 'water', 'black': 'death', 'gold': 'dragon', 'gray': 'neutral', 'red': 'fire' };
    return colors[color.toLowerCase()] || color;
}

function getImageUrl(cardName, editionId, cardSet) {
    // Special handling for specific sets
    if (cardSet === 'gladius') {
        return `https://d36mxiodymuqjm.cloudfront.net/cards_gladiator/${encodeURIComponent(cardName)}.png`;
    }
    if (cardSet === 'chaos' && editionId === 8) {
        return `https://d36mxiodymuqjm.cloudfront.net/cards_riftwatchers/${encodeURIComponent(cardName)}.jpg`;
    }
    if (cardSet === 'chaos' && editionId === 10) {
        return `https://d36mxiodymuqjm.cloudfront.net/cards_soulbound/${encodeURIComponent(cardName)}.jpg`;
    }
    if (cardSet === 'rebellion' && editionId === 13) {
        return `https://d36mxiodymuqjm.cloudfront.net/cards_soulboundrb/${encodeURIComponent(cardName)}.jpg`;
    }
    
    const config = EDITION_PATHS[editionId.toString()] || { folder: 'cards_beta', ext: 'png' };
    return `https://d36mxiodymuqjm.cloudfront.net/${config.folder}/${encodeURIComponent(cardName)}.${config.ext}`;
}

async function computeCollection() {
    const button = document.querySelector('button');
    button.textContent = 'Processing...';
    button.disabled = true;

    const usernames = document.getElementById('usernames').value
        .split(/[\s,]+/)
        .map(name => name.trim().toLowerCase())
        .filter(name => name !== "");

    const allCheckbox = document.getElementById('allCheckbox').checked;
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    const filters = {
        set: document.getElementById('cardSetFilter').value,
        edition: document.getElementById('editionFilter').value,
        color: document.getElementById('colorFilter').value,
        type: document.getElementById('typeFilter').value.toLowerCase(),
        rarity: document.getElementById('rarityFilter').value
    };

    let allCardsAggregate = {};
    
    // Enable comprehensive debugging when Foundations is selected
    let debugMode = filters.set === 'foundations';
    let uniqueCardSets = new Set();
    let edition15Cards = [];

    for (const username of usernames) {
        let cardAggregates = {};
        try {
            const response = await fetch(`https://api.splinterlands.io/cards/collection/${username}`);
            const data = await response.json();

            // First pass: collect all unique card_set values for debugging
            if (debugMode) {
                data.cards.forEach(card => {
                    uniqueCardSets.add(card.card_set);
                    if (card.edition === 15) {
                        const detail = cardDetails[card.card_detail_id] || {};
                        edition15Cards.push({
                            name: detail.name,
                            card_set: card.card_set,
                            edition: card.edition,
                            card_detail_id: card.card_detail_id
                        });
                    }
                });
            }

            data.cards.forEach(card => {
                const detail = cardDetails[card.card_detail_id] || {};
                const color = getColorText(detail.color || '');
                const rarity = getRarityText(detail.rarity);
                
                // Filter by card set using the card_set field from collection API
                if (filters.set && card.card_set !== filters.set) return;
                
                // Filter by edition (only works when set is selected)
                if (filters.set && filters.edition && card.edition.toString() !== filters.edition) return;
                
                if (filters.color && color !== filters.color) return;
                //if (filters.type && (detail.type||'').toLowerCase() !== filters.type) return;
				
				const cardType = (detail.type || '').toLowerCase();

				// Always ignore non-monster/summoner cards
				if (cardType !== 'monster' && cardType !== 'summoner') return;

				// Then apply user filter
				if (filters.type && cardType !== filters.type) return;
			
                if (filters.rarity && rarity !== filters.rarity) return;

                const key = `${detail.name}_${card.edition}`;
                if (!cardAggregates[key]) cardAggregates[key] = createBaseCard(detail, card);
                if (!allCardsAggregate[key]) allCardsAggregate[key] = createBaseCard(detail, card);

                updateBcx(cardAggregates[key], card);
                updateBcx(allCardsAggregate[key], card);
            });

            if (!allCheckbox) displayData(Object.values(cardAggregates), resultsDiv, username);
        } catch (e) { console.error(`Failed to fetch ${username}`); }
    }

    // Output debug information
    if (debugMode) {
        console.log('=== FOUNDATIONS DEBUG INFO ===');
        console.log('All unique card_set values found in collection:', Array.from(uniqueCardSets).sort());
        console.log('Cards with edition 15:', edition15Cards);
        console.log('Expected card_set value: "foundations"');
        console.log('==============================');
    }

    if (allCheckbox) displayData(Object.values(allCardsAggregate), resultsDiv, "Total Aggregate");

    button.textContent = 'Compute Collection';
    button.disabled = false;
}

function createBaseCard(detail, card) {
    return {
        name: detail.name || 'N/A',
        color: getColorText(detail.color || ''),
        rarity: getRarityText(detail.rarity),
        type: detail.type || 'N/A',
        edition: card.edition,
        cardSet: card.card_set,
        regularBCX: 0, goldBCX: 0, maxRegularCards: 0, maxGoldCards: 0
    };
}

function updateBcx(target, card) {
    if (card.gold) target.goldBCX += card.xp;
    else target.regularBCX += card.xp;
    target.maxRegularCards = computeMaxCards(target.rarity, target.regularBCX, false);
    target.maxGoldCards = computeMaxCards(target.rarity, target.goldBCX, true);
}

function computeMaxCards(rarity, bcx, isGold) {
    const limits = { 'common': isGold ? 38 : 400, 'rare': isGold ? 22 : 115, 'epic': isGold ? 10 : 46, 'legendary': isGold ? 4 : 11 };
    return Math.floor(bcx / (limits[rarity] || 1));
}

function displayData(dataList, resultsDiv, title) {
    const userDiv = document.createElement('div');
    userDiv.className = 'user-results';
    userDiv.innerHTML = `<h2>${title}</h2>`;
    const table = document.createElement('table');
    table.innerHTML = `<tr>
        <th>Image</th>
        <th>Name</th>
        <th>Splinter</th>
        <th>Rarity</th>
        <th>Type</th>
        <th>Regular<br>BCX</th>
        <th>Gold<br>BCX</th>
        <th>Max<br>Reg</th>
        <th>Max<br>Gold</th>
    </tr>`;

    dataList.sort((a,b) => a.name.localeCompare(b.name)).forEach(card => {
        const row = document.createElement('tr');
        const imgUrl = getImageUrl(card.name, card.edition, card.cardSet);
        row.innerHTML = `
            <td><img src="${imgUrl}" alt="${card.name}" class="card-image" onerror="this.src=this.src.replace('.png','.jpg')"></td>
            <td>${card.name}</td><td>${card.color}</td><td>${card.rarity}</td><td>${card.type}</td>
            <td>${card.regularBCX}</td><td>${card.goldBCX}</td><td>${card.maxRegularCards}</td><td>${card.maxGoldCards}</td>`;
        table.appendChild(row);
    });
    userDiv.appendChild(table);
    resultsDiv.appendChild(userDiv);
}

fetchCardDetails();
    </script>
</body>
</html>


